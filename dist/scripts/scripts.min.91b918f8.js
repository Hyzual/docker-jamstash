"use strict";angular.module("JamStash",["ngCookies","ngRoute","ngSanitize","jamstash.subsonic.controller","jamstash.archive.controller","jamstash.player.controller","jamstash.queue.controller","jamstash.persistence"]).config(["$routeProvider",function(a){a.when("/index",{redirectTo:"/library"}).when("/settings",{templateUrl:"settings/settings.html",controller:"SettingsController"}).when("/queue",{templateUrl:"queue/queue.html",controller:"QueueController"}).when("/library",{templateUrl:"subsonic/subsonic.html",controller:"SubsonicController"}).when("/library/:artistId",{templateUrl:"subsonic/subsonic.html",controller:"SubsonicController",reloadOnSearch:!1}).when("/library/:artistId/:albumId",{templateUrl:"subsonic/subsonic.html",controller:"SubsonicController",reloadOnSearch:!1}).when("/podcasts",{templateUrl:"podcasts/podcasts.html",controller:"PodcastController"}).when("/archive",{templateUrl:"archive/archive.html",controller:"ArchiveController"}).when("/archive/:artist",{templateUrl:"archive/archive.html",controller:"ArchiveController"}).when("/archive/:artist/:album",{templateUrl:"archive/archive.html",controller:"ArchiveController"}).otherwise({redirectTo:"/index"})}]).config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$location","$q","globals",function(a,b,c,d){return{request:function(c){a.loggedIn=!1,""!=d.settings.Username&&""!=d.settings.Password&&""!=d.settings.Server&&(a.loggedIn=!0);var e="";return e=b.path(),d.settings.Debug&&console.log("Logged In: "+a.loggedIn),d.settings.Debug&&console.log("Current Path: "+e),!a.loggedIn&&"/settings"!=e&&e.search("archive")<0&&b.path("/settings"),c},responseError:function(d){return 401===d.status&&"/settings"!=b.path()&&(a.loggedIn=!1,b.path("/settings")),c.reject(d)}}}])}]),angular.module("JamStash").controller("SettingsController",["$rootScope","$scope","$routeParams","$location","utils","globals","json","notifications","persistence","subsonic",function(a,b,c,d,e,f,g,h,i,j){a.hideQueue(),b.settings=f.settings,b.Timeouts=[{id:1e4,name:10},{id:2e4,name:20},{id:3e4,name:30},{id:4e4,name:40},{id:5e4,name:50},{id:6e4,name:60},{id:9e4,name:90},{id:12e4,name:120}],b.Protocols=["json","jsonp"],b.Themes=["Default","Dark"],b.SearchTypes=f.SearchTypes,b.Layouts=f.Layouts,b.$watch("settings.HideAZ",function(){f.settings.HideAZ?$("#AZIndex").hide():$("#AZIndex").show()}),b.reset=function(){e.setValue("Settings",null,!0),b.loadSettings()},b.save=function(){""!==b.settings.Password&&"enc:"!=f.settings.Password.substring(0,4)&&(b.settings.Password="enc:"+e.HexEncode(b.settings.Password)),0!=b.settings.Server.indexOf("http://")&&0!=b.settings.Server.indexOf("https://")&&(b.settings.Server="http://"+b.settings.Server),b.settings.NotificationSong&&(h.requestPermissionIfRequired(),h.isSupported()||alert("HTML5 Notifications are not available for your current browser, Sorry :(")),b.settings.NotificationNowPlaying&&(h.requestPermissionIfRequired(),h.isSupported()||alert("HTML5 Notifications are not available for your current browser, Sorry :(")),b.settings.SaveTrackPosition?i.saveQueue():(i.deleteTrackPosition(),i.deleteQueue()),b.settings.Theme&&e.switchTheme(f.settings.Theme),b.settings.ShowQueue?a.showQueue():a.hideQueue(),e.setValue("Settings",b.settings,!0),h.updateMessage("Settings Updated!",!0),b.loadSettings(),""!==f.settings.Server&&""!==f.settings.Username&&""!==f.settings.Password&&j.ping().then(function(b){f.settings.ApiVersion=b.version,d.path("/library").replace(),a.showIndex=!0},function(a){var b;b=void 0!==a.subsonicError?a.reason+" "+a.subsonicError.message:void 0!==a.httpError?a.reason+" HTTP error "+a.httpError:a.reason,h.updateMessage(b,!0)})},g.getChangeLog(function(a){b.changeLog=a.slice(0,10),f.ChangeLog=a;var c=b.changeLog[0].version;e.getValue("JamstashVersion")||e.setValue("JamstashVersion",c);var d=e.getValue("JamstashVersion");e.checkVersionNewer(d,c)&&(e.setValue("JamstashVersion",c),h.updateMessage("Version "+d+" to "+c,!0))}),b.changeLogShowMore=function(){g.getChangeLog(function(a){b.changeLog=a})},b.setupDemo=function(){var b="android-guest",c="guest",g="http://demo.subsonic.org";e.confirmDelete("Do you want to connect to the Subsonic Demo server?")&&(f.settings.Username=b,f.settings.Password=c,f.settings.Server=g,d.path("/library").replace(),a.showIndex=!0)},"undefined"!=typeof d.search().url&&""===b.settings.Server&&(f.settings.Debug&&console.log("Setting Provided: "+d.search().url),b.settings.Server=d.search().url),"undefined"!=typeof d.search().u&&""===b.settings.Username&&(f.settings.Debug&&console.log("Setting Provided: "+d.search().u),b.settings.Username=d.search().u)}]),angular.module("jamstash.settings",[]).service("globals",function(){this.SearchTypes=[{id:"song",name:"Song"},{id:"album",name:"Album"},{id:"artist",name:"Artist"}],this.Layouts=[{id:"grid",name:"Grid"},{id:"list",name:"List"}],this.AlbumSorts=[{id:"default",name:"Default Sort"},{id:"artist",name:"Artist"},{id:"album",name:"Album"},{id:"track",name:"Track"},{id:"createdate desc",name:"Date Added"}],this.settings={Url:"http://jamstash.com/#/archive/",Username:"",Password:"",Server:"",Timeout:2e4,Protocol:"jsonp",ApplicationName:"Jamstash",ApiVersion:"1.6.0",AutoPlaylists:"",AutoPlaylistSize:25,AutoAlbumSize:15,HideAZ:!1,ScrollTitle:!0,NotificationSong:!0,NotificationNowPlaying:!1,SaveTrackPosition:!1,ForceFlash:!1,Theme:"Default",DefaultLibraryLayout:this.Layouts[0],DefaultSearchType:this.SearchTypes[0],DefaultAlbumSort:this.AlbumSorts[0],DefaultArchiveAlbumSort:"date desc",Jukebox:!1,AutoPlay:!1,LoopQueue:!1,Repeat:!1,Debug:!1,ShowQueue:!1},this.SavedCollections=[],this.SavedGenres=[],this.Player1="#playdeck_1",this.archiveUrl="https://archive.org/",this.ChangeLog=null,this.Messages=[],this.BaseURL=function(){return this.settings.Server+"/rest"},this.BaseParams=function(){return"u="+this.settings.Username+"&p="+this.settings.Password+"&f="+this.settings.Protocol+"&v="+this.settings.ApiVersion+"&c="+this.settings.ApplicationName},this.BaseJSONParams=function(){return"u="+this.settings.Username+"&p="+this.settings.Password+"&f=json&v="+this.settings.ApiVersion+"&c="+this.settings.ApplicationName}}).factory("json",["$http",function(a){return{getCollections:function(b){a.get("archive/json_collections.json").success(b)},getChangeLog:function(b){a.get("common/json_changelog.json").success(b)}}}]),angular.module("jamstash.model",["jamstash.utils"]).service("model",["utils",function(a){this.Index=function(a,b){this.name=a,this.artist=b},this.Artist=function(a,b){this.id=a,this.name=b},this.Album=function(a,b,c,d,e,f,g,h,i,j,k,l){this.id=a,this.parentid=b,this.name=c,this.artist=d,this.artistId=e,this.coverartthumb=f,this.coverartfull=g,this.date=h,this.starred=i,this.description=j,this.url=k,this.type=l},this.Song=function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){this.id=b,this.parentid=c,this.track=d,this.name=e,this.artist=f,this.artistId=g,this.album=h,this.albumId=i,this.coverartthumb=j,this.coverartfull=k,this.duration=l,this.time=""===l?"00:00":a.secondsToTime(l),this.rating=m,this.starred=n,this.suffix=o,this.specs=p,this.url=q,this.position=r,this.selected=!1,this.playing=!1,this.description=s,this.displayName=this.name+" - "+this.album+" - "+this.artist}}]).service("map",["$http","globals","utils","model",function(a,b,c,d){this.mapArtist=function(a){var b="",c=a.artist,e=[];return c.length>0?e=c:e[0]=c,angular.forEach(e,function(a){"undefined"!=typeof a.name&&(a.name=a.name.toString())}),"undefined"!=typeof a.name&&(b=a.name.toString()),new d.Index(b,e)},this.mapIndex=function(a){var b,c="";return"undefined"!=typeof a.id&&(c=a.id),"undefined"!=typeof a.name&&(b=a.name.toString()),new d.Artist(c,b)},this.mapAlbum=function(a){var c,e,f,g,h=a;"undefined"!=typeof h.coverArt&&(e=b.BaseURL()+"/getCoverArt.view?"+b.BaseParams()+"&size=160&id="+h.coverArt,f=b.BaseURL()+"/getCoverArt.view?"+b.BaseParams()+"&id="+h.coverArt),g="undefined"!=typeof h.starred?!0:!1,c="undefined"!=typeof h.title?h.title:h.name;var i;return i=h.isDir?"byfolder":"bytag",new d.Album(h.id,h.parent,c,h.artist.toString(),h.artistId,e,f,$.format.date(new Date(h.created),"yyyy-MM-dd h:mm a"),g,"","",i)},this.mapSong=function(a){var c,e,f,g,h,i,j,k=a,l="",m="",n="";"undefined"!=typeof k.coverArt?(m=b.BaseURL()+"/getCoverArt.view?"+b.BaseParams()+"&size=30&id="+k.coverArt,n=b.BaseURL()+"/getCoverArt.view?"+b.BaseParams()+"&id="+k.coverArt):(m="images/albumdefault_60.a457ae64.jpg",n="images/albumdefault_160.973dd405.jpg"),j="undefined"==typeof k.description?"":k.description,f="undefined"==typeof k.artist?"&nbsp;":k.artist.toString(),e="undefined"==typeof k.title?"&nbsp;":k.title.toString(),g="undefined"==typeof k.track?"&nbsp;":k.track.toString(),h="undefined"!=typeof k.starred?!0:!1,void 0!==k.bitRate&&(l+=k.bitRate+" Kbps"),l+=void 0!==k.transcodedSuffix?", transcoding:"+k.suffix+" > "+k.transcodedSuffix:", "+k.suffix,i=void 0!==k.transcodedSuffix?k.transcodedSuffix:k.suffix,"ogg"==i&&(i="oga");var o=Math.floor(1e5*Math.random());return c=b.BaseURL()+"/stream.view?"+b.BaseParams()+"&id="+k.id+"&salt="+o,new d.Song(k.id,k.parent,g,e,f,k.artistId,k.album,k.albumId,m,n,k.duration,k.userRating,h,i,l,c,0,j)},this.mapPlaylist=function(a){return new d.Artist(a.id,a.name)},this.mapPodcast=function(a){var c,e,f,g,h,i,j,k,l=a,m="",n="",o="";"undefined"!=typeof l.coverArt&&(n=b.BaseURL()+"/getCoverArt.view?"+b.BaseParams()+"&size=60&id="+l.coverArt,o=b.BaseURL()+"/getCoverArt.view?"+b.BaseParams()+"&id="+l.coverArt),j="undefined"==typeof l.album?"&nbsp;":l.album.toString(),i="undefined"==typeof l.artist?"&nbsp;":l.artist.toString(),k="undefined"==typeof l.title?"&nbsp;":l.title.toString(),h="undefined"==typeof l.description?"":l.description,e="undefined"==typeof l.track?"&nbsp;":l.track.toString(),f="undefined"!=typeof l.starred?!0:!1,void 0!==l.bitRate&&(m+=l.bitRate+" Kbps"),m+=void 0!==l.transcodedSuffix?", transcoding:"+l.suffix+" > "+l.transcodedSuffix:", "+l.suffix,g=void 0!==l.transcodedSuffix?l.transcodedSuffix:l.suffix,"ogg"==g&&(g="oga");var p=Math.floor(1e5*Math.random());return c=b.BaseURL()+"/stream.view?"+b.BaseParams()+"&id="+l.streamId+"&salt="+p,new d.Song(l.streamId,l.parent,e,k,i,l.artistId,j,l.albumId,n,o,l.duration,l.userRating,f,g,m,c,0,h)}}]),angular.module("jamstash.utils",["jamstash.settings"]).service("utils",["$rootScope","globals",function(a,b){this.safeApply=function(b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?b&&"function"==typeof b&&b():this.$apply(b)},this.setValue=function(a,c){try{localStorage.setItem(a,JSON.stringify(c))}catch(d){b.settings.Debug&&console.log(d)}},this.getValue=function(a){try{var c=localStorage.getItem(a);return""!==c&&"undefined"!=typeof c?JSON.parse(c):!1}catch(d){b.settings.Debug&&console.log(d)}},this.sortDateFunction=function(a,b){return a.date<b.date?1:-1},this.sortArtistFunction=function(a,b){return a.artist.toLowerCase()<b.artist.toLowerCase()?-1:1},this.sortAlbumFunction=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:1},this.sortTrackFunction=function(a,b){return parseInt(a.track)>parseInt(b.track)?-1:1},this.confirmDelete=function(a){var b=window.confirm(a);return b?!0:!1},this.makeBaseAuth=function(a,b){var c=a+":"+b,d=$.base64Encode(c);return"Basic "+d},this.HexEncode=function(a){for(var b="0123456789abcdef",c=[],d=[],e=0;256>e;e++)c[e]=b.charAt(e>>4)+b.charAt(15&e);for(e=0;e<a.length;e++)d[e]=c[a.charCodeAt(e)];return d.join("")},this.switchTheme=function(a){switch(a.toLowerCase()){case"dark":$("link[data-name=theme]").attr("href","styles/Dark.5199c1bc.css");break;case"default":$("link[data-name=theme]").attr("href","")}},this.timeToSeconds=function(a){var b,c=a.split(":");switch(c.length){case 1:b=0;break;case 2:b=60*parseInt(c[0])+parseInt(c[1]);break;case 3:b=60*parseInt(c[0])*60+60*parseInt(c[1])+parseInt(c[2])}return b},this.secondsToTime=function(a){for(var b,c=new Array(3600,60,1),d="",e=0;e<c.length;e++)b=Math.floor(a/c[e]),1>b?b="00":10>b&&(b="0"+b),0===e&&"00"===b||(d+=b,2>e&&(d+=":")),a%=c[e];return d},this.arrayObjectIndexOf=function(a,b,c){for(var d=0,e=a.length;e>d;d++)if(a[d][c]===b)return d;return-1},this.logObjectProperties=function(a){$.each(a,function(a,b){var c=a;"object"==typeof b?$.each(b,function(a,b){console.log(c+" > "+a+" : "+b)}):console.log(a+" : "+b)})},this.clickButton=function(a){var a=$(a);if(a)for(var b=$(a).attr("class").split(" "),c=0,d=b.length;d>c;++c){var e=["shuffle","mute"];if(jQuery.inArray(b[c],e)>=0){var f=b[c]+"_up";return a.hasClass(f)?(a.removeClass(f),!1):(a.addClass(f),!0)}}},this.findKeyForCode=function(a){var b={keymap:[{key:"a",code:65},{key:"b",code:66},{key:"c",code:67},{key:"d",code:68},{key:"e",code:69},{key:"f",code:70},{key:"g",code:71},{key:"h",code:72},{key:"i",code:73},{key:"j",code:74},{key:"k",code:75},{key:"l",code:76},{key:"m",code:77},{key:"n",code:78},{key:"o",code:79},{key:"p",code:80},{key:"q",code:81},{key:"r",code:82},{key:"s",code:83},{key:"t",code:84},{key:"u",code:85},{key:"v",code:86},{key:"w",code:87},{key:"x",code:88},{key:"y",code:89},{key:"z",code:90}]},c=0;return $.each(b.keymap,function(b,d){d.code===a&&(c=d.key)}),c},this.toHTML={on:function(a){for(var b=[],c=0;c<a.length;)b[c]=a.charCodeAt(c++);return"&#"+b.join(";&#")+";"},un:function(a){return a.replace(/&#(x)?([^;]{1,5});?/g,function(a,b,c){return String.fromCharCode(parseInt(c,b?16:10))})}},this.getParameterByName=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.search);return null===d?"":decodeURIComponent(d[1].replace(/\+/g," "))},this.getPathFromUrl=function(a){var b=a.toString(),c=b.substring(0,b.indexOf("?"));return c},this.parseVersionString=function(a){if("string"!=typeof a)return!1;var b=a.split("."),c=parseInt(b[0])||0,d=parseInt(b[1])||0,e=parseInt(b[2])||0;return{major:c,minor:d,patch:e}},this.checkVersion=function(a,b){return a.major>=b.major&&a.minor>=b.minor&&a.patch>=b.patch?!0:!1},this.checkVersionNewer=function(a,b){return a.major<b.major?!0:a.minor<b.minor?!0:a.patch<b.patch?!0:!1},this.reloadRoute=function(){reload?$window.location.reload():$route.reload()},this.parseDate=function(a){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],c=a.split(" "),d=c[0].split("-"),e=parseInt(d[1],10)-1,f=b[e]+" "+d[2]+", "+d[0];return f}}]),angular.module("jamstash.page",["jamstash.settings","jamstash.utils"]).factory("Page",["$interval","globals","utils",function(a,b,c){var d,e="Jamstash";return{title:function(){return e},setTitle:function(a){return e=a,this},setTitleSong:function(a){return e=void 0!==a.artist&&void 0!==a.name?c.toHTML.un(a.artist)+" - "+c.toHTML.un(a.name):"Jamstash",b.settings.ScrollTitle&&this.scrollTitle(),this},scrollTitle:function(){var b={left:function(a){a.push(a.shift())},right:function(a){a.unshift(a.pop())}},c={text:e,dir:"left",speed:1200},f=c.text.split("");return f?(f.push(" "),void 0!==d&&a.cancel(d),d=a(function(){var a=b[c.dir];a&&(a(f),e=f.join(""))},c.speed),this):void 0}}}]),angular.module("jamstash.notifications",["jamstash.player.service","jamstash.utils"]).service("notifications",["$rootScope","$window","$interval","globals","player","utils",function(a,b,c,d,e,f){this.updateMessage=function(b,c){if(""!==b){var e=a.Messages.push(b)-1;$("#messages").fadeIn(),c&&setTimeout(function(){$("#msg_"+e).fadeOut(function(){$(this).remove()})},d.settings.Timeout)}},this.requestPermissionIfRequired=function(){this.isSupported()&&!this.hasPermission()&&window.Notify.requestPermission()},this.hasPermission=function(){return!b.Notify.needsPermission()},this.isSupported=function(){return window.Notify.isSupported()},this.showNotification=function(b){if(this.hasPermission()){var g=new Notify(f.toHTML.un(b.name),{body:f.toHTML.un(b.artist+" - "+b.album),icon:b.coverartthumb,notifyClick:function(){e.nextTrack(),this.close(),a.$apply()}});c(function(){g.close()},d.settings.Timeout),g.show()}else console.log("showNotification: No Permission")}}]),angular.module("jamstash.persistence",["jamstash.settings","jamstash.player.service","jamstash.notifications","angular-locker"]).config(["lockerProvider",function(a){a.setDefaultDriver("local").setDefaultNamespace("jamstash").setEventsEnabled(!1)}]).service("persistence",["globals","player","notifications","locker",function(a,b,c,d){this.loadTrackPosition=function(){var c=d.get("CurrentSong");c&&b.load(c),a.settings.Debug&&console.log("Current Position Loaded from localStorage: ",c)},this.saveTrackPosition=function(b){d.put("CurrentSong",b),a.settings.Debug&&console.log("Saving Current Position: ",b)},this.deleteTrackPosition=function(){d.forget("CurrentSong"),a.settings.Debug&&console.log("Removing Current Position from localStorage")},this.loadQueue=function(){var e=d.get("CurrentQueue");e&&(b.addSongs(e),b.queue.length>0&&c.updateMessage(b.queue.length+" Saved Song(s)",!0),a.settings.Debug&&console.log("Play Queue Loaded from localStorage: "+b.queue.length+" song(s)"))},this.saveQueue=function(){d.put("CurrentQueue",b.queue),a.settings.Debug&&console.log("Saving Queue: "+b.queue.length+" songs")},this.deleteQueue=function(){d.forget("CurrentQueue"),a.settings.Debug&&console.log("Removing Play Queue from localStorage")}}]),angular.module("JamStash").controller("AppController",["$scope","$rootScope","$document","$window","$location","$cookieStore","$http","utils","globals","model","notifications","player","persistence","Page",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b.settings=i.settings,b.song=[],b.playingSong=null,b.MusicFolders=[],b.Genres=[],b.Messages=[],b.SelectedMusicFolder="",b.unity=null,a.Page=n,b.loggedIn=function(){return""!==i.settings.Server&&""!==i.settings.Username&&""!==i.settings.Password?!0:!1},b.totalDisplayed=50,b.loadMore=function(){a.totalDisplayed+=50},b.go=function(a){e.path(a)},a.loadSettings=function(){f.get("Settings")&&(h.setValue("Settings",f.get("Settings"),!1),f.remove("Settings")),h.getValue("Settings")&&$.each(h.getValue("Settings"),function(a,b){"false"==b&&(b=!1),"true"==b&&(b=!0);var c=["Url"],d=c.indexOf(a);-1===d&&(i.settings[a]=b)}),h.getValue("SavedCollections")&&(i.SavedCollections=h.getValue("SavedCollections").split(",")),h.getValue("DefaultCollection")&&(i.DefaultCollection=h.getValue("DefaultCollection")),h.getValue("SavedGenres")&&(i.SavedGenres=h.getValue("SavedGenres").split(",")),i.settings.Debug&&console.log("Loaded Settings: "+JSON.stringify(i.settings,null,2))},a.toggleSetting=function(a){var b=a;i.settings[b]=i.settings[b]?!1:!0,k.updateMessage(a+" : "+i.settings[b],!0)},$.ajaxSetup({beforeSend:function(){$("#loading").show()},complete:function(){$("#loading").hide()}});var o=!1;$("div.submenu").mouseenter(function(){o=!0}),$("div.submenu").mouseleave(function(){o=!1,$("div.submenu").hide()}),a.toggleSubmenu=function(a,b,c,d){var e=$(a);if("none"!==e.css("display"))e.fadeOut();else{{var f=$(b),g=f.offset();f.width(),f.height()}switch(c){case"right":e.css({left:g.left+d+"px",top:g.top+"px"}).fadeIn(400);break;case"left":e.css({left:g.left-d+"px",top:g.top+"px"}).fadeIn(400)}setTimeout(function(){o===!1&&$("div.submenu").stop().fadeOut()},1e4)}},a.$watchCollection(function(){return l.queue},function(b){void 0!==b&&b.length>0&&i.settings.ShowQueue&&a.showQueue()}),b.showQueue=function(){$("#SideBar").css("display","block"),$("#right-component").removeClass("lgcolumn_expanded")},b.hideQueue=function(){$("#SideBar").css("display","none"),$("#right-component").addClass("lgcolumn_expanded")},a.toggleQueue=function(){"none"===$("#SideBar").css("display")?b.showQueue():b.hideQueue()},b.showArtists=function(){$("#left-component").css("display",""),$("#right-component").removeClass("lgcolumn_expandedleft")},b.hideArtists=function(){$("#left-component").css("display","none"),$("#right-component").addClass("lgcolumn_expandedleft")},a.toggleArtists=function(){"none"==$("#left-component").css("display")?b.showArtists():b.hideArtists()},a.fancyboxOpenImage=function(a){$.fancybox.open({helpers:{overlay:{css:{background:"rgba(0, 0, 0, 0.15)"}}},hideOnContentClick:!0,type:"image",openEffect:"none",closeEffect:"none",href:a})},$(document).on("click",".message",function(){$(this).remove()}),window.onbeforeunload=function(){return!i.settings.Debug&&l.queue.length>0?"You're about to end your session, are you sure?":void 0},b.showIndex=!1,$(document).on("click","message",function(){return $(this).fadeOut(function(){$(this).remove()}),!1}),c.keydown(function(b){a.scrollToIndex(b)}),a.scrollToIndex=function(a){var b=a.target.id;if("INPUT"!=a.target.tagName.toUpperCase()){var c=a.charCode?a.charCode:a.keyCode;if(i.settings.Debug&&console.log("Keycode Triggered: "+c),49==c?$("#action_Queue").click():50==c?$("#action_Library").click():51==c?$("#action_Archive").click():52==c&&$("#action_Settings").click(),c>=65&&90>=c&&$("#tabLibrary").is(":visible")){var d=h.findKeyForCode(c);("x"==d||"y"==d||"z"==d)&&(d="x-z");var e="#"+d.toUpperCase();$(e).length>0&&$("#left-component").stop().scrollTo(e,400)}else if(39==c||176==c)l.nextTrack();else if(37==c||177==c)l.previousTrack();else{if(32==c||179==c||"0179"==c.toString())return l.pause(),!1;36==c&&$("#tabLibrary").is(":visible")&&$("#left-component").stop().scrollTo("#MusicFolders",400)}if(189==c){var f=h.getValue("Volume")?parseFloat(h.getValue("Volume")):1;1>=f&&f>0&&""===b&&(f+=-.1,$(i.Player1).jPlayer({volume:f}),h.setValue("Volume",f,!0),i.settings.Debug&&console.log("Volume: "+Math.round(100*f)+"%"))}if(187==c){var f=h.getValue("Volume")?parseFloat(h.getValue("Volume")):1;1>f&&f>=0&&0==b&&(f+=.1,$(i.Player1).jPlayer({volume:f}),h.setValue("Volume",f,!0),i.settings.Debug&&console.log("Volume: "+Math.round(100*f)+"%"))}}return!0},a.scrollToIndexName=function(a){var b="#"+a;$(b).length>0&&$("#left-component").stop().scrollTo(b,400)},a.scrollToTop=function(){$("#left-component").stop().scrollTo("#MusicFolders",400)},b.selectAll=function(b){angular.forEach(b,function(b){a.selectedSongs.push(b),b.selected=!0})},b.selectNone=function(b){angular.forEach(b,function(b){a.selectedSongs=[],b.selected=!1})},b.playAll=function(a){l.queue=[],b.selectAll(a),b.addSongsToQueue();var c=l.queue[0];l.play(c)},b.playFrom=function(c,d){var e=d.slice(c,d.length);if(a.selectedSongs=[],angular.forEach(e,function(b){a.selectedSongs.push(b),b.selected=!0}),a.selectedSongs.length>0){l.queue=[],b.addSongsToQueue();var f=l.queue[0];l.play(f)}},b.addSongsToQueue=function(){0!==a.selectedSongs.length&&(angular.forEach(a.selectedSongs,function(a){l.queue.push(a),a.selected=!1}),k.updateMessage(a.selectedSongs.length+" Song(s) Added to Queue",!0),a.selectedSongs.length=0)},b.removeSong=function(a,b){var c=b.indexOf(a);b.splice(c,1)},a.isActive=function(a){return a===e.path()},b.reloadRoute=function(a){h.reloadRoute(a)},b.getSplitPosition=function(a,b){window.alert(b.getBoundingClientRect().left)},a.download=function(a){$.ajax({url:i.BaseURL()+"/getUser.view?"+i.BaseParams()+"&username="+i.settings.Username,method:"GET",dataType:i.settings.Protocol,timeout:i.settings.Timeout,success:function(b){"undefined"!=typeof b["subsonic-response"].error?k.updateMessage("Error: "+b["subsonic-response"].error.message,!0):b["subsonic-response"].user.downloadRole===!0?d.location.href=i.BaseURL()+"/download.view?"+i.BaseParams()+"&id="+a:k.updateMessage("You do not have permission to Download",!0)}})},a.selectedSongs=[],a.selectSong=function(b){var c=a.selectedSongs.indexOf(b);c>=0?(a.selectedSongs.splice(c,1),b.selected=!1):(a.selectedSongs.push(b),b.selected=!0)},b.addToJukebox=function(a){i.settings.Debug&&console.log("LOAD JUKEBOX"),$.ajax({url:i.BaseURL()+"/jukeboxControl.view?"+i.BaseParams()+"&action=set&id="+a,method:"GET",dataType:i.settings.Protocol,timeout:i.settings.Timeout,success:function(){$.get(i.BaseURL()+"/jukeboxControl.view?"+i.BaseParams()+"&action=start")}})},b.sendToJukebox=function(a){i.settings.Debug&&console.log("SEND JUKEBOX "+a),$.ajax({url:i.BaseURL()+"/jukeboxControl.view?"+i.BaseParams()+"&action="+a,method:"GET",dataType:i.settings.Protocol,timeout:i.settings.Timeout,success:function(){}})},a.updateFavorite=function(a){var b,c=a.id,d=a.starred;d?(b=i.BaseURL()+"/unstar.view?"+i.BaseParams()+"&id="+c,a.starred=void 0):(b=i.BaseURL()+"/star.view?"+i.BaseParams()+"&id="+c,a.starred=!0),$.ajax({url:b,method:"GET",dataType:i.settings.Protocol,timeout:i.settings.Timeout,success:function(){k.updateMessage("Favorite Updated!",!0)}})},a.toTrusted=function(a){return $sce.trustAsHtml(a)},a.loadSettings(),h.switchTheme(i.settings.Theme),i.settings.ShowQueue||b.hideQueue(),a.loggedIn()&&i.settings.SaveTrackPosition&&(m.loadQueue(),m.loadTrackPosition())}]),angular.module("jamstash.subsonic.controller",["jamstash.subsonic.service","jamstash.player.service"]).controller("SubsonicController",["$scope","$rootScope","$routeParams","utils","globals","map","subsonic","notifications","player",function(a,b,c,d,e,f,g,h,i){a.settings=e.settings,a.itemType="ss",a.Server=e.settings.Server,a.playlistMenu=[],a.AutoAlbums=[{id:"random",name:"Random"},{id:"newest",name:"Recently Added"},{id:"starred",name:"Starred"},{id:"highest",name:"Top Rated"},{id:"frequent",name:"Most Played"},{id:"recent",name:"Recently Played"}],a.SelectedAlbumSort=e.settings.DefaultAlbumSort,a.AlbumSort=e.AlbumSorts,b.showIndex=g.showIndex,a.$watch("showIndex",function(a,c){a!==c&&(g.showIndex=b.showIndex)}),a.toggleIndex=function(){b.showIndex?b.showIndex=!1:(b.showIndex=!0,a.showPlaylist=!1,a.showPodcast=!1),a.saveDefaultSection("index")},a.showPlaylist=g.showPlaylist,a.$watch("showPlaylist",function(b,c){b!==c&&(g.showPlaylist=a.showPlaylist)}),a.togglePlaylist=function(){a.showPlaylist?a.showPlaylist=!1:(a.showPlaylist=!0,b.showIndex=!1,a.showPodcast=!1),a.saveDefaultSection("playlist")},a.showPodcast=g.showPodcast,a.$watch("showPodcast",function(b,c){b!==c&&(g.showPodcast=a.showPodcast)}),a.togglePodcast=function(){a.showPodcast?a.showPodcast=!1:(a.showPodcast=!0,a.showPlaylist=!1,b.showIndex=!1),a.saveDefaultSection("podcast")},a.saveDefaultSection=function(a){d.setValue("DefaultSection",a,!1)},a.openDefaultSection=function(){var c=d.getValue("DefaultSection");switch(c){case"index":b.showIndex=!0;break;case"playlist":a.showPlaylist=!0;break;case"podcast":a.showPodcast=!0}};var j=function(b){if("undefined"!=typeof b)switch(b){case"createdate desc":a.album.sort(d.sortDateFunction);break;case"artist":a.album.sort(d.sortArtistFunction);break;case"album":a.album.sort(d.sortAlbumFunction)}},k=function(b){if("undefined"!=typeof b)switch(b){case"createdate desc":a.song.sort(d.sortDateFunction);break;case"artist":a.song.sort(d.sortArtistFunction);break;case"album":a.song.sort(d.sortAlbumFunction);break;case"track":a.song.sort(d.sortTrackFunction)}};a.$watch("SelectedAlbumSort.id",function(b,c){if(b!==c)if(a.song.length>0)k(b);else if(a.album.length>0){j(b);var d=$.map(e.AlbumSorts,function(a,c){return a.id===b?c:void 0});e.settings.DefaultAlbumSort=e.AlbumSorts[d]}}),b.$watch("SelectedMusicFolder",function(b,c){b!==c&&(d.setValue("MusicFolders",angular.toJson(b),!0),a.getArtists(b.id,!0))}),a.SearchType=e.settings.DefaultSearchType,a.SearchTypes=e.SearchTypes,a.playlistsGenre=e.SavedGenres,a.$watch("selectedGenre",function(a,b){a!==b&&(e.SavedGenres.push(a),d.setValue("SavedGenres",e.SavedGenres.join(),!1))}),a.rescanLibrary=function(){$.ajax({url:e.BaseURL()+"/getUser.view?"+e.BaseParams()+"&username="+e.settings.Username,method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(a){a["subsonic-response"].user.adminRole===!0?$.get(e.settings.Server+"/musicFolderSettings.view?scanNow&"+e.BaseParams()):alert("You are not logged in as an admin user!")}})},a.selectAll=function(){b.selectAll(a.song)},a.selectNone=function(){b.selectNone(a.song)},a.playAll=function(){b.playAll(a.song)},a.playFrom=function(c){b.playFrom(c,a.song)},a.removeSong=function(c){b.removeSong(c,a.song)},a.songsRemoveSelected=function(){g.songsRemoveSelected(a.selectedSongs).then(function(b){a.album=b.album,a.song=b.song})},a.getArtists=function(b,c){g.getArtists(b,c).then(function(b){a.index=b.artists,a.shortcut=b.shortcuts,a.BreadCrumbs=b.breadcrumb})},a.refreshArtists=function(){d.setValue("MusicFolders",null,!0),a.getArtists(0,!0),a.getPlaylists(!0)},a.getAlbums=function(b,c){g.getAlbums(b,c).then(function(b){a.album=b.album,a.song=b.song,console.log(a.song.length),a.BreadCrumbs=b.breadcrumb,a.selectedAutoAlbum=b.selectedAutoAlbum,a.selectedArtist=b.selectedArtist,a.selectedAlbum=b.selectedAlbum,a.selectedPlaylist=b.selectedPlaylist,"default"!=SelectedAlbumSort.id&&j(SelectedAlbumSort.id)})},a.getAlbumListBy=function(b,c){g.getAlbumListBy(b,c).then(function(b){a.album=b.album,a.song=b.song,a.BreadCrumbs=b.breadcrumb,a.selectedAutoAlbum=b.selectedAutoAlbum,a.selectedArtist=b.selectedArtist,a.selectedPlaylist=b.selectedPlaylist,"default"!=SelectedAlbumSort.id&&j(SelectedAlbumSort.id)})},a.requestSongs=function(b,c){return b.then(function(b){"play"===c?(i.emptyQueue().addSongs(b).playFirstSong(),h.updateMessage(b.length+" Song(s) Added to Queue",!0)):"add"===c?(i.addSongs(b),h.updateMessage(b.length+" Song(s) Added to Queue",!0)):"display"===c&&(a.album=[],a.song=b)},function(a){var b;b=void 0!==a.subsonicError?a.reason+" "+a.subsonicError.message:void 0!==a.httpError?a.reason+" HTTP error "+a.httpError:a.reason,h.updateMessage(b,!0)}),b},a.getSongs=function(b,c){g.getSongs(b,c).then(function(b){a.album=b.album,a.song=b.song,a.BreadCrumbs=b.breadcrumb,a.selectedAutoAlbum=b.selectedAutoAlbum,a.selectedArtist=b.selectedArtist,a.selectedPlaylist=b.selectedPlaylist,"default"!=SelectedAlbumSort.id&&j(SelectedAlbumSort.id)})},a.getRandomStarredSongs=function(b){var c=g.getRandomStarredSongs();a.requestSongs(c,b),a.selectedPlaylist=null,a.selectedAutoPlaylist="starred"},a.getRandomSongs=function(b,c,d){var e=g.getRandomSongs(c,d);a.requestSongs(e,b),a.selectedPlaylist=null,a.selectedAutoPlaylist=isNaN(d)?void 0!==c&&""!==c&&"Random"!==c?c:"random":d},a.getArtistByTag=function(b){a.selectedAutoAlbum=null,a.selectedArtist=b;var c=e.BaseURL()+"/getArtist.view?"+e.BaseParams()+"&id="+b;$.ajax({url:c,method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(b){var c=[];"undefined"!=typeof b["subsonic-response"].artist?(b["subsonic-response"].artist.album.length>0?c=b["subsonic-response"].artist.album:c[0]=b["subsonic-response"].artist.album,g.content.album=[],g.song=[],angular.forEach(c,function(a){g.content.album.push(f.mapAlbum(a))}),a.$apply()):h.updateMessage("No Albums Returned :(",!0)}})},a.getAlbumByTag=function(b){g.getAlbumByTag(b).then(function(b){a.album=b.album,a.song=b.song,a.BreadCrumbs=b.breadcrumb,a.selectedAutoAlbum=b.selectedAutoAlbum,a.selectedArtist=b.selectedArtist,a.selectedPlaylist=b.selectedPlaylist})},a.search=function(){var b=$("#Search").val(),c=$("#SearchType").val();g.search(b,c).then(function(b){a.album=b.album,a.song=b.song})},a.toggleAZ=function(){a.toggleSubmenu("#submenu_AZIndex","#AZIndex","right",44)},a.getPlaylists=function(b){g.getPlaylists(b).then(function(b){a.playlists=b.playlists,a.playlistsPublic=b.playlistsPublic,a.selectedAutoPlaylist=b.selectedAutoPlaylist,a.selectedPlaylist=b.selectedPlaylist})},a.getPlaylist=function(b,c){g.getPlaylist(b,c).then(function(b){a.album=b.album,a.song=b.song,a.selectedAutoPlaylist=b.selectedAutoPlaylist,a.selectedPlaylist=b.selectedPlaylist})},a.getStarred=function(b,c){g.getStarred(b,c).then(function(b){a.album=b.album,a.song=b.song,a.selectedAutoPlaylist=b.selectedAutoPlaylist,a.selectedPlaylist=b.selectedPlaylist})},a.newPlaylist=function(b,c){g.newPlaylist(b,c).then(function(){a.getPlaylists(!0)})},a.deletePlaylist=function(){g.deletePlaylist().then(function(){a.getPlaylists(!0)})},a.savePlaylist=function(){var b=a.selectedPlaylist;g.savePlaylist().then(function(){a.getPlaylist(b,""),h.updateMessage("Playlist Updated!",!0)})},a.loadPlaylistsForMenu=function(){$.ajax({url:e.BaseURL()+"/getPlaylists.view?"+e.BaseParams(),method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(b){var c=[];
a.playlistMenu=[],"undefined"!=typeof b["subsonic-response"].playlists.playlist&&(b["subsonic-response"].playlists.playlist.length>0?c=b["subsonic-response"].playlists.playlist:c[0]=b["subsonic-response"].playlists.playlist,angular.forEach(c,function(b){b.owner==e.settings.Username&&a.playlistMenu.push(f.mapPlaylist(b))}),a.playlistMenu.length>0?(a.$apply(),a.toggleSubmenu("#submenu_AddToPlaylist","#action_AddToPlaylist","left",124)):h.updateMessage("No Playlists :(",!0))}})},a.addToPlaylist=function(b){var c=[];if(0!==a.selectedSongs.length){angular.forEach(a.selectedSongs,function(a){c.push(a.id)});var f=d.parseVersionString(e.settings.ApiVersion),g=d.parseVersionString("1.8.0");d.checkVersion(f,g)&&$.ajax({type:"GET",url:e.BaseURL()+"/updatePlaylist.view?"+e.BaseParams(),dataType:e.settings.Protocol,timeout:e.settings.Timeout,data:{playlistId:b,songIdToAdd:c},success:function(){a.selectedSongs.length=0,h.updateMessage("Playlist Updated!",!0)},traditional:!0})}},a.getGenres=function(){g.getGenres().then(function(b){a.Genres=b})},a.getPodcasts=function(b){g.getPodcasts(b).then(function(b){a.podcasts=b})},a.getPodcast=function(b,c){g.getPodcast(b,c).then(function(b){a.album=b.album,a.song=b.song,a.selectedPodcast=b.selectedPodcast})},a.getMusicFolders=function(){$.ajax({url:e.BaseURL()+"/getMusicFolders.view?"+e.BaseParams(),method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(c){if(void 0!==c["subsonic-response"].musicFolders.musicFolder){var e=[];if(c["subsonic-response"].musicFolders.musicFolder.length>0?e=c["subsonic-response"].musicFolders.musicFolder:e[0]=c["subsonic-response"].musicFolders.musicFolder,e.unshift({id:-1,name:"All Folders"}),b.MusicFolders=e,d.getValue("MusicFolders")){var f=angular.fromJson(d.getValue("MusicFolders")),g=0,h="";angular.forEach(b.MusicFolders,function(a){a.id==f.id&&(h=g),g++}),b.SelectedMusicFolder=b.MusicFolders[h]}else b.SelectedMusicFolder=b.MusicFolders[0];a.$apply()}}})},a.dragStart=function(a,b){b.item.data("start",b.item.index())},a.dragEnd=function(b,c){var d=c.item.data("start"),e=c.item.index();a.song.splice(e,0,a.song.splice(d,1)[0])},a.playSong=function(a){i.play(a)},a.addSongToQueue=function(a){i.addSong(a)},a.getArtists(),a.getAlbums(),a.getPlaylists(),a.getGenres(),a.getPodcasts(),a.openDefaultSection(),a.getMusicFolders(),c.artistId&&c.albumId?a.getAlbumByTag(c.albumId):c.artistId&&a.getAlbums(c.artistId)}]),angular.module("jamstash.subsonic.service",["jamstash.settings","jamstash.utils","jamstash.model","jamstash.notifications","jamstash.player.service","angular-underscore/utils"]).factory("subsonic",["$rootScope","$http","$q","globals","utils","map","notifications","player",function(a,b,c,d,e,f,g,h){var i={shortcuts:[],artists:[]},j={album:[],song:[],playlists:[],breadcrumb:[],playlistsPublic:[],playlistsGenre:d.SavedGenres,selectedAutoAlbum:null,selectedArtist:null,selectedAlbum:null,selectedPlaylist:null,selectedAutoPlaylist:null,selectedGenre:null,selectedPodcast:null},k=[],l=[],m=0,n=!1;return{showIndex:a.showIndex,showPlaylist:n,getSongTemplate:function(a){var c="16608",e=d.BaseURL()+"/getMusicDirectory.view?"+d.BaseParams()+"&id="+c;b.get(e).success(function(b){var c=[],d=[];"undefined"!=typeof b["subsonic-response"].directory.child&&(b["subsonic-response"].directory.child.length>0?c=b["subsonic-response"].directory.child:c[0]=b["subsonic-response"].directory.child,angular.forEach(c,function(a){a.isDir||d.push(f.mapSong(a))}),a(d))})},subsonicRequest:function(a,e){var f={reason:"Error when contacting the Subsonic server."},g=c.defer(),h="/"===a.charAt(0)?a:"/"+a,i=d.BaseURL()+h,j=e||{},k=j.params||{};k.u=d.settings.Username,k.p=d.settings.Password,k.f=d.settings.Protocol,k.v=d.settings.ApiVersion,k.c=d.settings.ApplicationName,j.params=k,j.timeout=d.settings.Timeout;var l;return"jsonp"===d.settings.Protocol?(j.params.callback="JSON_CALLBACK",l=b.jsonp(i,j)):l=b.get(i,j),l.success(function(a){var b=void 0!==a["subsonic-response"]?a["subsonic-response"]:{status:"failed"};"ok"===b.status?g.resolve(b):("failed"===b.status&&void 0!==b.error&&(f.subsonicError=b.error),g.reject(f))}).error(function(a,b){f.httpError=b,g.reject(f)}),g.promise},ping:function(){return this.subsonicRequest("ping.view")},getArtists:function(a,b){var g=c.defer();if(b||0==i.artists.length){var h;if(e.getValue("MusicFolders")){var j=angular.fromJson(e.getValue("MusicFolders"));a=j.id}h=a?d.BaseURL()+"/getIndexes.view?"+d.BaseParams()+"&musicFolderId="+a:d.BaseURL()+"/getIndexes.view?"+d.BaseParams(),$.ajax({url:h,method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(a){var b=[];"undefined"!=typeof a["subsonic-response"].indexes.index&&(a["subsonic-response"].indexes.index.length>0?b=a["subsonic-response"].indexes.index:b[0]=a["subsonic-response"].indexes.index),i.artists=[],i.shortcuts=[];var c=[];"undefined"!=typeof a["subsonic-response"].indexes.shortcut&&(a["subsonic-response"].indexes.shortcut.length>0?c=a["subsonic-response"].indexes.shortcut:c[0]=a["subsonic-response"].indexes.shortcut,angular.forEach(c,function(a){i.shortcuts.push(f.mapIndex(a))})),angular.forEach(b,function(a){i.artists.push(f.mapArtist(a))}),g.resolve(i)}})}else g.resolve(i);return g.promise},getAlbums:function(a,b){var e={reason:"No songs found on the Subsonic server."},g={size:d.settings.AutoAlbumSize,id:a},h=this.subsonicRequest("getMusicDirectory.view",{params:g}).then(function(d){return void 0!==d.directory.child&&d.directory.child.length>0?(j.song=[],j.album=[],j.breadcrumb=[],j.breadcrumb.push({type:"artist",id:a,name:b}),angular.forEach(d.directory.child,function(a){a.isDir?j.album.push(f.mapAlbum(a)):j.song.push(f.mapSong(a))}),j):c.reject(e)});return h},getAlbumListBy:function(a,b){"next"==b?m+=d.settings.AutoAlbumSize:"prev"==b?m-=d.settings.AutoAlbumSize:m=0;var e={reason:"No songs found on the Subsonic server."},g={size:d.settings.AutoAlbumSize,type:a,offset:m},h=this.subsonicRequest("getAlbumList.view",{params:g}).then(function(b){return void 0!==b.albumList.album&&b.albumList.album.length>0?(j.song=[],j.album=[],j.selectedArtist=null,j.selectedPlaylist=null,j.selectedAutoAlbum=a,j.breadcrumb=[],angular.forEach(b.albumList.album,function(a){a.isDir?j.album.push(f.mapAlbum(a)):j.song.push(f.mapSong(a))}),j):c.reject(e)});return h},getAlbumByTag:function(a){var b=c.defer();return $.ajax({url:d.BaseURL()+"/getAlbum.view?"+d.BaseParams()+"&id="+a,method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(a){if("undefined"!=typeof a["subsonic-response"].album){j.album=[],j.song=[];var c=[];a["subsonic-response"].album.song.length>0?c=a["subsonic-response"].album.song:c[0]=a["subsonic-response"].album.song,angular.forEach(c,function(a){j.song.push(f.mapSong(a))})}b.resolve(j)}}),b.promise},getSongs:function(a,b){var d={reason:"No songs found on the Subsonic server."},e={id:a},i=this.subsonicRequest("getMusicDirectory.view",{params:e}).then(function(e){if(void 0!==e.directory.child&&e.directory.child.length>0){var i=e.directory.child;if(j.selectedAlbum=a,"add"==b)angular.forEach(i,function(a){h.queue.push(f.mapSong(a))}),g.updateMessage(i.length+" Song(s) Added to Queue",!0);else if("play"==b){h.queue=[],angular.forEach(i,function(a){h.queue.push(f.mapSong(a))});var k=h.queue[0];h.play(k),g.updateMessage(i.length+" Song(s) Added to Queue",!0)}else{if("undefined"!=e.directory.id){var l=e.directory.id,m=e.directory.name;j.breadcrumb.length>0&&j.breadcrumb.splice(1,j.breadcrumb.length-1),j.breadcrumb.push({type:"album",id:l,name:m})}j.song=[],j.album=[];var n=[];angular.forEach(i,function(a){a.isDir?n.push(f.mapAlbum(a)):j.song.push(f.mapSong(a))}),n.length>0&&(j.album=n)}return j}return c.reject(d)});return i},search:function(a,b){var e=c.defer();return""!==a&&$.ajax({url:d.BaseURL()+"/search2.view?"+d.BaseParams()+"&query="+a,method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(a){if(""!==a["subsonic-response"].searchResult2){var c=[];"0"===b&&void 0!==a["subsonic-response"].searchResult2.song&&(a["subsonic-response"].searchResult2.song.length>0?c=a["subsonic-response"].searchResult2.song:c[0]=a["subsonic-response"].searchResult2.song,j.album=[],j.song=[],angular.forEach(c,function(a){j.song.push(f.mapSong(a))})),"1"===b&&void 0!==a["subsonic-response"].searchResult2.album&&(a["subsonic-response"].searchResult2.album.length>0?c=a["subsonic-response"].searchResult2.album:c[0]=a["subsonic-response"].searchResult2.album,j.album=[],j.song=[],angular.forEach(c,function(a){a.isDir?j.album.push(f.mapAlbum(a)):j.song.push(f.mapAlbum(a))})),"2"===b&&void 0!==a["subsonic-response"].searchResult2.artist&&(a["subsonic-response"].searchResult2.artist.length>0?c=a["subsonic-response"].searchResult2.artist:c[0]=a["subsonic-response"].searchResult2.artist,angular.forEach(c,function(a){i.shortcuts.push(a)})),e.resolve(j)}}}),e.promise},getRandomSongs:function(a,b){var e={reason:"No songs found on the Subsonic server."},g={size:d.settings.AutoPlaylistSize};void 0!==a&&""!==a&&"Random"!==a&&(g.genre=a),isNaN(b)||(g.musicFolderId=b);var h=this.subsonicRequest("getRandomSongs.view",{params:g}).then(function(a){if(void 0!==a.randomSongs&&a.randomSongs.song.length>0){var b=[];return angular.forEach(a.randomSongs.song,function(a){b.push(f.mapSong(a))}),b}return c.reject(e)});return h},getPlaylists:function(a){var b=c.defer();return d.settings.Debug&&console.log("LOAD PLAYLISTS"),a||0==j.playlists.length?$.ajax({url:d.BaseURL()+"/getPlaylists.view?"+d.BaseParams(),method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(a){if(void 0!==a["subsonic-response"].playlists.playlist){var c=[];a["subsonic-response"].playlists.playlist.length>0?c=a["subsonic-response"].playlists.playlist:c[0]=a["subsonic-response"].playlists.playlist,j.playlists=[],j.playlistsPublic=[],angular.forEach(c,function(a){a.owner==d.settings.Username?j.playlists.push(a):a.public&&j.playlistsPublic.push(a)}),b.resolve(j)}}}):b.resolve(j),b.promise},getPlaylist:function(a,b){var e=c.defer();return j.selectedAutoPlaylist=null,j.selectedPlaylist=a,$.ajax({url:d.BaseURL()+"/getPlaylist.view?"+d.BaseParams()+"&id="+a,method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(a){if("undefined"!=typeof a["subsonic-response"].playlist.entry){var c=[],d=a["subsonic-response"].playlist;if(d.entry.length>0?c=d.entry:c[0]=d.entry,"add"==b)angular.forEach(c,function(a){h.queue.push(f.mapSong(a))}),g.updateMessage(c.length+" Song(s) Added to Queue",!0);else if("play"==b){h.queue=[],angular.forEach(c,function(a){h.queue.push(f.mapSong(a))});var i=h.queue[0];h.play(i),g.updateMessage(c.length+" Song(s) Added to Queue",!0)}else j.album=[],j.song=[],angular.forEach(c,function(a){j.song.push(f.mapSong(a))}),g.updateMessage(c.length+" Song(s) in Playlist",!0)}else j.song=[];e.resolve(j)}}),e.promise},getStarred:function(){var a=this.subsonicRequest("getStarred.view",{cache:!0}).then(function(a){return angular.equals(a.starred,{})?c.reject({reason:"Nothing is starred on the Subsonic server."}):a.starred});return a},getRandomStarredSongs:function(){var a=this.getStarred().then(function(a){if(void 0!==a.song&&a.song.length>0){var b=[].concat(_(a.song).sample(d.settings.AutoPlaylistSize)),e=[];return angular.forEach(b,function(a){e.push(f.mapSong(a))}),e}return c.reject({reason:"No starred songs found on the Subsonic server."})});return a},newPlaylist:function(){var a=c.defer(),b=prompt("Choose a name for your new playlist.","");return"null"!=b&&null!==b&&""!==b&&$.ajax({url:d.BaseURL()+"/createPlaylist.view?"+d.BaseParams()+"&name="+b,method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(){a.resolve()}}),a.promise},deletePlaylist:function(){var a=c.defer();if(null!==j.selectedPlaylist){var b=j.selectedPlaylist;e.confirmDelete("Are you sure you want to delete the selected playlist?")&&$.ajax({url:d.BaseURL()+"/deletePlaylist.view?"+d.BaseParams()+"&id="+b,method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(){a.resolve()}})}return a.promise},savePlaylist:function(){var a=c.defer();if(null!==j.selectedPlaylist){var b=j.selectedPlaylist,e=[];angular.forEach(j.song,function(a){e.push(a.id)}),e.length>0&&$.ajax({type:"GET",url:d.BaseURL()+"/createPlaylist.view?"+d.BaseParams(),dataType:d.settings.Protocol,timeout:d.settings.Timeout,data:{playlistId:b,songId:e},success:function(){a.resolve()},traditional:!0})}return a.promise},songsRemoveSelected:function(a){var b=c.defer();return angular.forEach(a,function(a){var b=j.song.indexOf(a);j.song.splice(b,1)}),b.resolve(j),b.promise},getGenres:function(){var a=c.defer(),b="Acid Rock,Acoustic,Alt Country,Alt/Indie,Alternative & Punk,Alternative Metal,Alternative,AlternRock,Awesome,Bluegrass,Blues,Blues-Rock,Classic Hard Rock,Classic Rock,Comedy,Country,Country-Rock,Dance,Dance-Rock,Deep Funk,Easy Listening,Electronic,Electronica,Electronica/Dance,Folk,Folk/Rock,Funk,Grunge,Hard Rock,Heavy Metal,Holiday,House,Improg,Indie Rock,Indie,International,Irish,Jam Band,Jam,Jazz Fusion,Jazz,Latin,Live Albums,Metal,Music,Oldies,Other,Pop,Pop/Rock,Post Rock,Progressive Rock,Psychedelic Rock,Psychedelic,Punk,R&B,Rap & Hip-Hop,Reggae,Rock & Roll,Rock,Rock/Pop,Roots,Ska,Soft Rock,Soul,Southern Rock,Thrash Metal,Unknown,Vocal,World";return k=b.split(","),a.resolve(k),a.promise},getPodcasts:function(){var a=c.defer();return d.settings.Debug&&console.log("LOAD PODCASTS"),$.ajax({url:d.BaseURL()+"/getPodcasts.view?"+d.BaseParams(),method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(b){if(void 0!==b["subsonic-response"].podcasts.channel){var c=[];b["subsonic-response"].podcasts.channel.length>0?c=b["subsonic-response"].podcasts.channel:c[0]=b["subsonic-response"].podcasts.channel,l=c}a.resolve(l)}}),a.promise},getPodcast:function(a,b){var e=c.defer();return j.selectedPodcast=a,$.ajax({url:d.BaseURL()+"/getPodcasts.view?"+d.BaseParams(),method:"GET",dataType:d.settings.Protocol,timeout:d.settings.Timeout,success:function(c){if(void 0!==c["subsonic-response"].podcasts.channel){var d=[];c["subsonic-response"].podcasts.channel.length>0?d=c["subsonic-response"].podcasts.channel:d[0]=c["subsonic-response"].podcasts.channel;var i=[];if($.each(d,function(b,c){c.id==a&&(i=c.episode)}),"undefined"!=typeof i)if("add"==b)angular.forEach(i,function(a){"skipped"!=a.status&&h.queue.push(f.mapPodcast(a))}),g.updateMessage(i.length+" Song(s) Added to Queue",!0);else if("play"==b){h.queue=[],angular.forEach(i,function(a){"skipped"!=a.status&&h.queue.push(f.mapPodcast(a))});var k=h.queue[0];h.play(k),g.updateMessage(i.length+" Song(s) Added to Queue",!0)}else j.album=[],j.song=[],angular.forEach(i,function(a){"skipped"!=a.status&&j.song.push(f.mapPodcast(a))})}e.resolve(j)}}),e.promise},scrobble:function(a){var b=this.subsonicRequest("scrobble.view",{params:{id:a.id,submisssion:!0}}).then(function(){return d.settings.Debug&&console.log("Successfully scrobbled song: "+a.id),!0});return b}}}]),angular.module("jamstash.archive.controller",["jamstash.archive.service"]).controller("ArchiveController",["$scope","$rootScope","$location","$routeParams","$http","$timeout","utils","globals","model","notifications","player","archive","json",function(a,b,c,d,e,f,g,h,i,j,k,l){a.settings=h.settings,a.itemType="archive",b.song=[],a.Protocol="jsonp",a.artist=[],a.album=[],a.selectedArtist=null,a.selectedAlbum=null,a.selectedSongs=[],a.SavedCollections=h.SavedCollections,a.AllArtists=[],a.loadedCollection=!1,a.writeSavedCollection=function(){g.setValue("SavedCollections",a.SavedCollections.join(),!1),h.SavedCollections=a.SavedCollections},a.addSavedCollection=function(b){if(-1==a.SavedCollections.indexOf(b)){a.SavedCollections.push(b),a.writeSavedCollection();var c=a.AllArtists.indexOf(b);a.AllArtists.splice(c,1)}},a.deleteSavedCollection=function(b){a.SavedCollections.splice(b,1),a.writeSavedCollection()},a.setupDemoCollections=function(){var b=["YonderMountainStringBand","GreenskyBluegrass"];angular.forEach(b,function(b){-1==a.SavedCollections.indexOf(b)&&a.SavedCollections.push(b)})},a.selectedArchiveAlbumSort=h.settings.DefaultArchiveAlbumSort,a.ArchiveAlbumSort=["addeddate desc","addeddate asc","avg_rating desc","avg_rating asc","createdate desc","createdate asc","date desc","date asc","downloads desc","downloads asc","num_reviews desc","num_reviews asc","publicdate desc","publicdate asc","stars desc","stars asc"],a.$watch("selectedArchiveAlbumSort",function(b){g.getValue("AlbumSort")!=b&&("undefined"!=typeof b?(g.setValue("AlbumSort",b,!0),h.settings.DefaultArchiveAlbumSort=b):g.setValue("AlbumSort",null,!0),a.getAlbums(a.selectedArtist))}),a.getYears=function(a){var b=(new Date).getFullYear(),c=[];for(a=a||1950;b>=a;)c.push(a++);return c},a.Years=a.getYears(),a.filter={Year:"",Source:"",Description:""},a.filterSave=function(){a.selectedArtist&&a.getAlbums(a.selectedArtist,a.filter)},a.getArtists=function(b){var c=$("#Artists").val(),d=$("#Collections option:selected").text();(b||c.length>=3)&&l.getArtists(c,d).then(function(b){a.AllArtists=b.artist,a.loadedCollection=!0})},a.getAlbums=function(b){l.getAlbums(b,a.filter).then(function(b){a.song=b.song,a.album=b.album,a.selectedArtist=b.selectedArtist,a.BreadCrumbs=b.breadcrumb})},a.getSongs=function(b,c){l.getSongs(b,c).then(function(b){a.album=b.album,a.song=b.song,a.selectedAlbum=b.selectedAlbum,a.BreadCrumbs=b.breadcrumb,f(function(){$.fancybox.update()})})},a.scrollToTop=function(){$("#Artists").stop().scrollTo("#auto",400)},a.selectAll=function(){b.selectAll(a.song)},a.selectNone=function(){b.selectNone(a.song)},a.playAll=function(){b.playAll(a.song)},a.playFrom=function(c){b.playFrom(c,a.song)},a.removeSong=function(c){b.removeSong(c,a.song)},a.getAlbums(),d.artist&&(d.album?a.getSongs(d.album):a.getAlbums(d.artist),a.addSavedCollection(d.artist))}]),angular.module("jamstash.archive.service",["jamstash.settings","jamstash.model","jamstash.notifications","jamstash.player.service"]).factory("archive",["$rootScope","$http","$q","$sce","globals","model","utils","map","notifications","player",function(a,b,c,d,e,f,g,h,i,j){var k={artist:[],album:[],song:[],breadcrumb:[],selectedArtist:null,selectedAlbum:null,selectedGenre:null,selectedArchiveAlbumSort:"date desc"},l=function(a){var b,c,g,h,i,j,k,l,m,n,o,p=a,q=e.archiveUrl+"details/"+p.identifier;b="images/albumdefault_50.7c4beb44.jpg",c="images/albumdefault_160.jpg",g=5==parseInt(p.avg_rating)?!0:!1,h="undefined"==typeof p.title?"&nbsp;":p.title.toString(),m="undefined"==typeof p.identifier?"&nbsp;":p.identifier.toString(),i="undefined"==typeof p.collection[0]?"&nbsp;":p.collection[0].toString(),n="undefined"==typeof p.source?"&nbsp;":p.source.toString(),o="undefined"==typeof p.date?"&nbsp;":p.date.toString(),j="undefined"==typeof p.publisher?"&nbsp;":p.publisher.toString(),k="undefined"==typeof p.avg_rating?"&nbsp;":p.avg_rating.toString(),l="undefined"==typeof p.downloads?"&nbsp;":p.downloads.toString();var r="<b>Source</b>: "+n+"<br />";return r+="<b>Date</b>: "+o+"<br />",r+="<b>Transferer</b>: "+j+"<br />",r+="<b>Rating</b>: "+k+"<br />",r+="<b>Downloads</b>: "+l+"<br />",new f.Album(m,null,h,i,"",b,c,$.format.date(new Date(p.publicdate),"yyyy-MM-dd h:mm a"),g,d.trustAsHtml(r),q)},m=function(a,b,c,d,e,h){var i,j,k,l,m="";return"VBR MP3"==b.format?(i="http://"+c+d+a,m="undefined"==typeof b.bitrate||"undefined"==typeof b.format?"&nbsp;":b.bitrate+"kbps, "+b.format.toLowerCase(),k="undefined"==typeof b.track?"&nbsp;":b.track,l="undefined"==typeof b.title?"&nbsp;":b.title,j="undefined"==typeof b.length?"&nbsp;":g.timeToSeconds(b.length),new f.Song(b.md5,e,b.track,l,b.creator,"",b.album,"",h,h,j,"","","mp3",m,i,0,"")):void 0};return{getArtists:function(a){var b=c.defer();e.settings.Debug&&console.log("LOAD ARCHIVE.ORG COLLECTIONS");var d=e.archiveUrl+"advancedsearch.php?q=";return d+=""!==a?"mediatype:(collection) AND identifier:("+a+")":"collection:(collection)",d+="&fl[]=identifier&sort[]=&sort[]=&sort[]=&rows=50&page=1&output=json",$.ajax({url:d,method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(a){if(a.response.docs.length>0){var c=a.response.docs;k.artist=[],angular.forEach(c,function(a){k.artist.push(a.identifier)})}else i.updateMessage("Sorry :(",!0);b.resolve(k)}}),b.promise},getAlbums:function(a,b){var d=c.defer();if(a){var f=e.archiveUrl+"advancedsearch.php?q=";""!==a?(k.selectedArtist=a,f+="collection:("+a+") AND format:(MP3)"):k.selectedArtist?(a=k.selectedArtist,f+="collection:("+k.selectedArtist+") AND format:(MP3)"):f+="collection:("+a+")",k.breadcrumb=[],k.breadcrumb.push({type:"artist",id:a,name:a}),b.Source&&(f+=" AND source:("+b.Source+")"),b.Year&&parseInt(b.Year)&&(f+=" AND year:("+b.Year+")"),b.Description&&(f+=" AND description:("+b.Description+")"),k.selectedArtist&&(f+="&sort[]="+e.settings.DefaultArchiveAlbumSort),f+="&fl[]=avg_rating,collection,date,description,downloads,headerImage,identifier,publisher,publicdate,source,subject,title,year",f+="&rows=50&page=1&output=json",$.ajax({url:f,method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(a){var b=[];a.response.docs.length>0?(b=a.response.docs,k.album=[],k.song=[],angular.forEach(b,function(a){k.album.push(l(a))}),i.updateMessage(k.album.length+" Items Returned",!0)):i.updateMessage("Sorry :(",!0),d.resolve(k)},error:function(){i.updateMessage("Archive.org service down :(")}})}else d.resolve(k);return d.promise},getSongs:function(a,b){var d=c.defer();if(a){k.selectedAlbum=a,k.breadcrumb.length>0&&k.breadcrumb.splice(1,k.breadcrumb.length-1),k.breadcrumb.push({type:"album",id:a,name:a});var f=e.archiveUrl+"details/"+a+"?output=json";$.ajax({url:f,method:"GET",dataType:e.settings.Protocol,timeout:e.settings.Timeout,success:function(a){var c="",e=a.server,f=a.dir,g=a.metadata.identifier[0];"undefined"!=typeof a.misc.image&&(c=a.misc.image);var h=a.files;if("add"==b)angular.forEach(h,function(a,b){var d=m(b,a,e,f,g,c);d&&j.queue.push(d)}),i.updateMessage(Object.keys(h).length+" Song(s) Added to Queue",!0);else if("play"==b){j.queue=[],angular.forEach(h,function(a,b){var d=m(b,a,e,f,g,c);d&&j.queue.push(d)});var l=j.queue[0];j.play(l),i.updateMessage(Object.keys(h).length+" Song(s) Added to Queue",!0)}else k.album=[],k.song=[],angular.forEach(h,function(a,b){var d=m(b,a,e,f,g,c);d&&k.song.push(d)});d.resolve(k)}})}else d.resolve(k);return d.promise}}}]),angular.module("jamstash.player.controller",["jamstash.player.service","jamstash.player.directive"]).controller("PlayerController",["$scope","player","globals",function(a,b,c){a.getPlayingSong=function(){return b.getPlayingSong()},a.play=function(){c.settings.Jukebox&&a.sendToJukebox("start")},a.pause=function(){c.settings.Jukebox&&a.sendToJukebox("stop")},a.previousTrack=function(){b.previousTrack()},a.nextTrack=function(){b.nextTrack()}}]),angular.module("jamstash.player.directive",["jamstash.player.service","jamstash.settings","jamstash.subsonic.service","jamstash.notifications","jamstash.persistence","jamstash.page"]).directive("jplayer",["$interval","player","globals","subsonic","notifications","persistence","Page",function(a,b,c,d,e,f,g){return{restrict:"EA",template:"<div></div>",link:function(h,i){$(".PlayTrack").on("click",function(a){a.preventDefault(),$(this).hide(),$(".PauseTrack").show()}),$(".PauseTrack").on("click",function(a){a.preventDefault(),$(this).hide(),$(".PlayTrack").show()});var j,k=i.children("div"),l="html,flash";c.settings.ForceFlash&&(l="flash,html");var m=function(){$.jPlayer.timeFormat.showHour=!0,k.jPlayer({swfPath:"bower_components/jplayer/dist/jplayer/jquery.jplayer.swf",wmode:"window",solution:l,supplied:"mp3, oga, m4a",preload:"auto",errorAlerts:!1,warningAlerts:!1,cssSelectorAncestor:"#player",cssSelector:{play:".PlayTrack",pause:".PauseTrack",seekBar:"#audiocontainer .scrubber",playBar:"#audiocontainer .progress",mute:"#action_Mute",unmute:"#action_UnMute",volumeMax:"#action_VolumeMax",currentTime:"#played",duration:"#duration"},setmedia:function(){h.scrobbled=!1},play:function(){h.revealControls()},ended:function(){b.isLastSongPlaying()&&c.settings.AutoPlay?d.getRandomSongs().then(function(a){b.addSongs(a).songEnded(),e.updateMessage("Auto Play Activated...",!0)}):b.songEnded(),h.$apply()},timeupdate:function(a){var b=a.jPlayer.status.currentPercentAbsolute,e=!a.jPlayer.status.paused;!h.scrobbled&&b>30&&e&&(c.settings.Debug&&console.log("LAST.FM SCROBBLE - Percent Played: "+b),d.scrobble(h.currentSong),h.scrobbled=!0)},error:function(a){var b=a.jPlayer.status.currentTime;b&&k.jPlayer("play",b),c.settings.Debug&&(console.log("jPlayer error: ",a.jPlayer.error),console.log("Stream interrupted, retrying from position: ",b))}})};h.$watch(function(){return b.getPlayingSong()},function(a){if(void 0!==a){h.currentSong=a,g.setTitleSong(a),$.fancybox.isOpen&&h.fancyboxOpenImage(a.coverartfull);var d={};"oga"===a.suffix?d={oga:a.url}:"m4a"===a.suffix?d={m4a:a.url}:"mp3"===a.suffix&&(d={mp3:a.url}),k.jPlayer("setMedia",d),c.settings.Jukebox&&(k.jPlayer("mute",!0),h.addToJukebox(a.id)),b.loadSong===!0||c.settings.Jukebox?(b.loadSong=!1,h.revealControls(),k.jPlayer("pause",a.position)):(k.jPlayer("play"),c.settings.NotificationSong&&e.showNotification(a))}}),h.$watch(function(){return b.restartSong},function(a){a===!0&&(k.jPlayer("play",0),h.scrobbled=!1,b.restartSong=!1)}),h.$watch(function(){return b.pauseSong},function(a){a===!0?(k.jPlayer("pause"),b.pauseSong=!0):(k.jPlayer("play"),b.pauseSong=!1)}),h.$watch(function(){return c.settings.SaveTrackPosition},function(a){a===!0&&h.startSavePosition()}),h.revealControls=function(){$("#playermiddle").css("visibility","visible"),$("#songdetails").css("visibility","visible")},h.startSavePosition=function(){c.settings.SaveTrackPosition&&(0!==j&&a.cancel(j),j=a(function(){var a=k.data("jPlayer");c.settings.SaveTrackPosition&&void 0!==h.currentSong&&void 0!==a&&a.status.currentTime>0&&a.status.paused===!1&&($("#action_SaveProgress").fadeTo("slow",0).delay(500).fadeTo("slow",1).delay(500).fadeTo("slow",0).delay(500).fadeTo("slow",1),h.currentSong.position=a.status.currentTime,f.saveTrackPosition(h.currentSong),f.saveQueue())},3e4))},j=0,h.currentSong={},h.scrobbled=!1,m(),h.startSavePosition(),$("#audiocontainer .scrubber").mouseover(function(){$(".audiojs .scrubber").stop().animate({height:"8px"})}),$("#audiocontainer .scrubber").mouseout(function(){$(".audiojs .scrubber").stop().animate({height:"4px"})})}}}]),angular.module("jamstash.player.service",["jamstash.settings","angular-underscore/utils"]).factory("player",["globals",function(a){var b={_playingIndex:-1,_playingSong:void 0,queue:[],restartSong:!1,loadSong:!1,play:function(a){var c=b.indexOfSong(a);b._playingIndex=void 0!==c?c:-1,b._playingSong===a?b.restart():b._playingSong=a},pause:function(){b.pauseSong=b.pauseSong?!1:!0},playFirstSong:function(){b._playingIndex=0,b.play(b.queue[0])},load:function(a){b.loadSong=!0,b.play(a)},restart:function(){b.restartSong=!0},songEnded:function(){a.settings.Repeat?b.restart():b.isLastSongPlaying()===!0?a.settings.LoopQueue&&b.playFirstSong():b.nextTrack()},nextTrack:function(){var a=b.indexOfSong(b._playingSong);if(b._playingIndex=void 0!==a?a:-1,b._playingIndex+1<b.queue.length){var c=b.queue[b._playingIndex+1];b._playingIndex++,b.play(c)}},previousTrack:function(){var a=b.indexOfSong(b._playingSong);if(b._playingIndex=void 0!==a?a:-1,b._playingIndex-1>0){var c=b.queue[b._playingIndex-1];b._playingIndex--,b.play(c)}else b.queue.length>0&&b.playFirstSong()},emptyQueue:function(){return b.queue=[],b},shuffleQueue:function(){return b.queue=_(b.queue).shuffle(),b},addSong:function(a){return b.queue.push(a),b},addSongs:function(a){return b.queue=b.queue.concat(a),b},removeSong:function(a){var c=b.queue.indexOf(a);return b.queue.splice(c,1),b},removeSongs:function(a){return b.queue=_(b.queue).difference(a),b},getPlayingSong:function(){return b._playingSong},isLastSongPlaying:function(){return b._playingIndex+1===b.queue.length},indexOfSong:function(a){for(var c=b.queue.length-1;c>=0;c--)if(angular.equals(a,b.queue[c]))return c;return void 0}};return b}]),angular.module("jamstash.queue.controller",["jamstash.player.service"]).controller("QueueController",["$scope","globals","player",function(a,b,c){a.settings=b.settings,a.player=c,a.playSong=function(a){c.play(a)},a.emptyQueue=function(){c.emptyQueue(),$.fancybox.close()},a.shuffleQueue=function(){c.shuffleQueue()},a.addSongToQueue=function(a){c.addSong(a)},a.removeSongFromQueue=function(a){c.removeSong(a)},a.removeSelectedSongsFromQueue=function(){c.removeSongs(a.selectedSongs)},a.isPlayingSong=function(a){return angular.equals(a,c.getPlayingSong())},a.$watch(function(){return c.getPlayingSong()},function(a){void 0!==a&&$("#SideBar").stop().scrollTo(".song.id"+a.id,400)}),a.dragStart=function(a,b){b.item.data("start",b.item.index())},a.dragEnd=function(a,b){var d=b.item.data("start"),e=b.item.index();c.queue.splice(e,0,c.queue.splice(d,1)[0])}}]),angular.module("JamStash").filter("capitalize",function(){return function(a){return a.substring(0,1).toUpperCase()+a.substring(1)}}).filter("musicfolder",function(){return function(a){return a.slice(1,a.length)}}).filter("capitalize",function(){return function(a){return a.substring(0,1).toUpperCase()+a.substring(1)}}),angular.module("JamStash").directive("sortable",function(){return{link:function(a,b){b.sortable({start:a.dragStart,update:a.dragEnd}),b.disableSelection()}}}).directive("fancybox",["$compile",function(a){return{restrict:"A",replace:!1,link:function(b,c){b.fancyboxOpen=function(){var d=angular.element(c.html()),e=a(d);$.fancybox.open(d),e(b)}}}}]).directive("songpreview",["$compile","subsonic",function(a,b){return{restrict:"E",templateUrl:"common/songs.html",replace:!1,scope:{song:"@"},link:function(a,c){b.getSongTemplate(function(b){a.song=b,$.fancybox.open(c)})}}}]).directive("stopEvent",function(){return{restrict:"A",link:function(a,b,c){b.bind(c.stopEvent,function(a){a.stopPropagation()})}}}).directive("ngEnter",function(){return{scope:{onEnter:"&"},link:function(a,b){console.log(a),b.bind("keydown keypress",function(b){13===b.which&&(a.onEnter(),a.$apply())})}}}).directive("ngDownload",["$compile",function(a){return{restrict:"E",scope:{data:"="},link:function(b,c){function d(){return URL.createObjectURL(new Blob([JSON.stringify(b.data)],{type:"application/json"}))}c.append(a('<a class="button" download="backup.json"href="'+d()+'">Download</a>')(b)),b.$watch(b.data,function(){c.children()[0].href=d()})}}}]).directive("stopEvent",function(){return{restrict:"A",link:function(a,b,c){b.bind(c.stopEvent,function(a){a.stopPropagation()})}}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).directive("ngMsgs",function(){return{restrict:"E",transclude:!1,scope:{msgs:"="},template:'<span id="msg_{{$index}}" class="message">{{ item }}</span>',link:function(a,b){a.$watch(a.Messages,function(){var c=$compile(template(a));b.append(c),$(b).parent().fadeIn()})}}});